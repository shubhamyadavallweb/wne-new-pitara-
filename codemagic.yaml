workflows:
  expo-android:
    # Builds a debug APK on pull requests for testing purposes.
    name: NewPitara â€“ Android APK (Debug)
    max_build_duration: 90
    instance_type: mac_mini_m2
    
    environment:
      node: "18.18.0"
      java: "17"
      vars:
        PROJECT_DIR: "apps/mobile"
        NODE_OPTIONS: "--max_old_space_size=4096"
        NODE_ENV: "development"
        EXPO_NO_DOTENV: "1"
        
    triggering:
      events:
        - pull_request
      branch_patterns:
        - pattern: "*" # Build on any branch PR
          include: true
      # a new build.
      cancel_previous_builds: true
          
    scripts:
      - name: Change to project directory
        script: |
          cd "$PROJECT_DIR"
          echo "ðŸ“ Working directory: $(pwd)"

      - name: Install npm dependencies
        script: |
          cd "$PROJECT_DIR"
          npm cache clean --force
          npm ci --legacy-peer-deps --no-audit --no-fund
          
      - name: Install Expo CLI
        script: |
          npm install -g @expo/cli@^0.16.1
          npx expo --version
          echo "âœ… Expo CLI installed successfully"

      - name: Expo prebuild (Android)
        script: |
          cd "$PROJECT_DIR"
          rm -rf android
          npx expo prebuild --platform android --clean --no-install
          
      - name: Build Android Debug APK
        script: |
          cd "$PROJECT_DIR"/android
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace
          
    artifacts:
      - "$PROJECT_DIR/android/app/build/outputs/apk/debug/*.apk"

  expo-android-release:
    # Builds a signed, production-ready release APK using EAS Build
    name: NewPitara â€“ Android Release APK (EAS Build)
    max_build_duration: 90
    instance_type: mac_mini_m2
    
    environment:
      node: "18.18.0"
      vars:
        PROJECT_DIR: "apps/mobile"
        NODE_OPTIONS: "--max_old_space_size=4096"
        NODE_ENV: "production"
        EXPO_NO_DOTENV: "1"
        EXPO_TOKEN: $EXPO_TOKEN # Direct access to EXPO_TOKEN variable
      groups:
        - x # IMPORTANT: Ensure this group contains all required secrets including EXPO_TOKEN
        
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "main"
          include: true
      # a new build.
      cancel_previous_builds: true
          
    scripts:
      - name: Change to project directory
        script: |
          cd "$PROJECT_DIR"
          echo "ðŸ“ Working directory: $(pwd)"

      - name: Install npm dependencies
        script: |
          echo "ðŸ“ Installing dependencies from monorepo root: $(pwd)"
          npm cache clean --force
          npm ci --legacy-peer-deps --no-audit --no-fund
          
      - name: Install EAS CLI
        script: |
          npm install -g @expo/cli@^0.16.1 eas-cli@latest
          npx expo --version
          eas --version
          echo "âœ… EAS CLI installed successfully"

      - name: Set up environment variables
        script: |
          cd "$PROJECT_DIR"
          cat > .env << EOF
          EXPO_PUBLIC_SUPABASE_URL=$EXPO_PUBLIC_SUPABASE_URL
          EXPO_PUBLIC_SUPABASE_ANON_KEY=$EXPO_PUBLIC_SUPABASE_ANON_KEY
          SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
          SUPABASE_ACCESS_TOKEN=$SUPABASE_ACCESS_TOKEN
          SUPABASE_PROJECT_REF=$SUPABASE_PROJECT_REF
          SUPABASE_DB_URL=$SUPABASE_DB_URL
          EXPO_PUBLIC_RAZORPAY_KEY=$EXPO_PUBLIC_RAZORPAY_KEY
          EXPO_PUBLIC_RAZORPAY_KEY_SECRET=$EXPO_PUBLIC_RAZORPAY_KEY_SECRET
          EXPO_PUBLIC_RAZORPAY_WEBHOOK_SECRET=$EXPO_PUBLIC_RAZORPAY_WEBHOOK_SECRET
          EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID=$EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID
          EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID=$EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID
          EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID=$EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID
          EXPO_PUBLIC_GOOGLE_WEB_CLIENT_SECRET=$EXPO_PUBLIC_GOOGLE_WEB_CLIENT_SECRET
          EXPO_PUBLIC_BYPASS_AUTH=$EXPO_PUBLIC_BYPASS_AUTH
          EXPO_PUBLIC_BUNNY_CDN_URL=$EXPO_PUBLIC_BUNNY_CDN_URL
          EOF
          echo "âœ… Environment variables configured"

      - name: Configure EAS credentials
        script: |
          cd "$PROJECT_DIR"
          echo "ðŸ” Setting up EAS credentials..."
          
          # Debug: Check if EXPO_TOKEN is available
          echo "ðŸ” Checking EXPO_TOKEN availability..."
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN environment variable is not set!"
            echo "Please ensure EXPO_TOKEN is in variable group 'x' in Codemagic"
            exit 1
          else
            echo "âœ… EXPO_TOKEN is available (length: ${#EXPO_TOKEN})"
          fi
          
          # Set CI environment variable for EAS authentication
          export CI=1
          export EXPO_TOKEN="$EXPO_TOKEN"
          
          echo "ðŸ”‘ Verifying EAS authentication..."
          # EAS CLI will automatically use EXPO_TOKEN when CI=1 is set
          npx expo whoami || {
            echo "âŒ Authentication failed with EXPO_TOKEN"
            echo "Please verify your EXPO_TOKEN is valid and has proper permissions"
            echo "Token should be generated with: expo token:create"
            echo "Ensure token is in variable group 'x' in Codemagic"
            exit 1
          }
          
          echo "âœ… EAS credentials configured successfully"

      - name: Build Android APK with EAS
        script: |
          cd "$PROJECT_DIR"
          
          echo "ðŸ”¨ Building Android APK using EAS..."
          
          # Set CI environment variable and EXPO_TOKEN for this step
          export CI=1
          export EXPO_TOKEN="$EXPO_TOKEN"
          
          # Verify we're still authenticated
          echo "ðŸ” Verifying authentication..."
          npx expo whoami || {
            echo "âŒ Not authenticated with Expo"
            exit 1
          }
          
          # Build APK using EAS with better error handling
          echo "ðŸš€ Starting EAS build..."
          if ! eas build --platform android --profile production --non-interactive --local --output build.apk; then
            echo "âŒ EAS build failed!"
            echo "ðŸ“‹ Build logs above should contain error details"
            exit 1
          fi
          
          echo "ðŸ“¦ Checking for APK files..."
          ls -la *.apk || echo "No APK files found in current directory"
          
          if [ -f "build.apk" ]; then
            echo "âœ… APK built successfully!"
            ls -la build.apk
          else
            echo "âŒ APK not found!"
            echo "ðŸ“ Checking for any APK files:"
            find . -name "*.apk" -type f || echo "No APK files found anywhere"
            exit 1
          fi

      - name: Copy APK to artifacts directory
        script: |
          echo "ðŸ“ Creating artifacts directory..."
          mkdir -p $CM_BUILD_DIR/artifacts
          
          cd "$PROJECT_DIR"
          echo "ðŸ” Looking for APK files..."
          find . -name "*.apk" -type f
          
          if [ -f "build.apk" ]; then
            echo "âœ… Copying main APK..."
            cp "build.apk" "$CM_BUILD_DIR/artifacts/pitara-release.apk"
          fi
          
          # Copy any other APK files found
          find . -name "*.apk" -exec cp {} $CM_BUILD_DIR/artifacts/ \; 2>/dev/null || echo "No additional APK files found"
          
          echo "ðŸ“¦ Final artifacts:"
          ls -la $CM_BUILD_DIR/artifacts/ || echo "No artifacts directory found"

    artifacts:
      - $PROJECT_DIR/android/app/build/outputs/apk/release/*.apk
      - $CM_BUILD_DIR/artifacts/*.apk
      
    publishing:
      email:
        recipients:
          - pitarasupabase@gmail.com
        notify:
          success: true
          failure: true 